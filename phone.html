<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대상자 서비스 모니터링 및 만족도 조사</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            line-height: 1.3;
            color: #333;
            max-width: 1920px;
            margin: 0 auto;
            padding: 5px;
        }
        
        .form-header {
            background-color: #1a5fa0;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .form-header h1 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .form-header .form-number {
            background-color: #1a5fa0;
            color: white;
            border: 1px solid white;
            padding: 3px 8px;
            border-radius: 3px;
            margin-right: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .section {
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: #fff;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 2px;
            border-bottom: 1px solid #1a5fa0;
            color: #1a5fa0;
            font-size: 0.85rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 3px;
        }
        
        th, td {
            padding: 3px 4px;
            text-align: left;
            border: 1px solid #ddd;
            font-size: 0.8rem;
        }
        
        .form-group {
            margin-bottom: 5px;
            padding: 4px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        
        label {
            display: block;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }
        
        input[type="text"], 
        input[type="date"],
        input[type="datetime-local"],
        select,
        textarea {
            width: 100%;
            padding: 3px 4px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-top: 1px;
            font-size: 0.8rem;
        }
        
        textarea {
            resize: none;
            height: 32px;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 1px;
        }
        
        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 2px;
            background-color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .submit-container {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        #extractBtn, #submitBtn {
            width: 150px;
        }
        
        #submitBtn {
            padding: 6px 16px;
            background-color: #1a5fa0;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        #submitBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        #submitBtn.active {
            background-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        }

        #statusMessage {
            padding: 5px;
            margin-top: 5px;
            border-radius: 3px;
            display: none;
            font-size: 0.8rem;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        /* 탭 스타일 추가 */
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            min-width: 150px;
            white-space: nowrap;
        }
        
        .tab-button.active {
            background-color: #1a5fa0;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* 이전/다음 버튼 스타일 */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .nav-button {
            padding: 10px 20px;
            background-color: #1a5fa0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        @media (max-width: 1800px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1400px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        /* 특정 섹션의 크기 조정 */
        #safety, #special {
            grid-row: span 1;
        }

        /* 라디오/체크박스 최적화 */
        input[type="radio"], input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        /* 결과 표시 영역 스타일 */
        .result-section {
            display: none;
            padding: 15px;
            border: 3px solid #ff0000;
            border-radius: 5px;
            background-color: #fff;
            position: fixed;
            top: 55px; /* 제목 바 아래로 조정 */
            right: 20px;
            width: 400px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        /* 명시적 스타일 추가 */
        .result-section.show {
            display: block !important;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1a5fa0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #1a5fa0;
        }

        .result-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .result-item {
            margin-bottom: 12px;
        }

        .result-label {
            font-weight: bold;
            color: #333;
        }

        .extract-button {
            padding: 6px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .extract-button:hover {
            background-color: #218838;
        }

        .result-content input, 
        .result-content textarea {
            width: 100%;
            box-sizing: border-box;
        }

        /* 결과 닫기 버튼 추가 */
        .result-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: #1a5fa0;
        }

        @media (max-width: 1200px) {
            .result-section {
                width: 350px;
            }
        }

        @media (max-width: 900px) {
            .result-section {
                position: static;
                width: 100%;
                max-height: none;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="form-header">
        <div class="form-number">서 식 1</div>
        <h1 id="formTitle">[모니터링] 대상자 서비스 모니터링 및 만족도 조사</h1>
    </div>
    
    <form id="serviceForm" novalidate>
        <div class="grid-container">
            <!-- 1. 기본정보 -->
            <div class="section">
                <div class="section-title">1. 기본정보</div>
                <table>
                    <tr>
                        <td>조사일자</td>
                        <td><input type="date" name="survey_date" id="survey_date"></td>
                    </tr>
                    <tr>
                        <td>작성자</td>
                        <td>
                            <select name="author" id="author">
                                <option value="">작성자를 선택하세요</option>
                                <option value="신용기">신용기</option>
                                <option value="이연숙">이연숙</option>
                                <option value="문일지">문일지</option>
                                <option value="이정혜">이정혜</option>
                                <option value="김수연">김수연</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>지역/수행기관명</td>
                        <td>
                            <select name="agency" id="agency">
                                <option value="">수행기관을 선택하세요</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>성명</td>
                        <td><input type="text" name="name"></td>
                    </tr>
                    <tr>
                        <td>생년월일</td>
                        <td>
                            <div class="radio-group" style="margin-bottom: 10px;">
                                <label><input type="radio" name="birthdate_period" value="before"> 1945년 1월 1일 이전</label>
                                <label><input type="radio" name="birthdate_period" value="after"> 1945년 1월 1일 이후</label>
                            </div>
                            <input type="date" name="birthdate" id="birthdate" style="display: none;">
                        </td>
                    </tr>
                    <tr>
                        <td>성별</td>
                        <td>
                            <div class="radio-group">
                                <label><input type="radio" name="gender" value="male"> 남</label>
                                <label><input type="radio" name="gender" value="female"> 여</label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>연락일시</td>
                        <td><input type="datetime-local" name="contact_time"></td>
                    </tr>
                </table>
            </div>

            <!-- 2. 전반적인 만족도 -->
            <div class="section">
                <div class="section-title">2. 전반적인 만족도</div>
                <div class="form-group">
                    <label>현재 서비스 만족도</label>
                    <div class="radio-group">
                        <label><input type="radio" name="satisfaction" value="very_satisfied"> 매우만족</label>
                        <label><input type="radio" name="satisfaction" value="satisfied"> 만족</label>
                        <label><input type="radio" name="satisfaction" value="neutral"> 보통</label>
                        <label><input type="radio" name="satisfaction" value="unsatisfied"> 불만족</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>생활 변화에 대한 도움 여부</label>
                    <div class="radio-group">
                        <label><input type="radio" name="helpful" value="very_helpful"> 매우그렇다</label>
                        <label><input type="radio" name="helpful" value="helpful"> 그렇다</label>
                        <label><input type="radio" name="helpful" value="neutral"> 보통이다</label>
                        <label><input type="radio" name="helpful" value="not_helpful"> 그렇지 않다</label>
                        <label><input type="radio" name="helpful" value="not_at_all"> 전혀 그렇지 않다</label>
                    </div>
                </div>
            </div>

            <!-- 3. 서비스 내용 -->
            <div class="section">
                <div class="section-title">3. 제공받은 서비스 내용 및 세부 만족 사항</div>
                
                <div class="form-group">
                    <label>현재 제공받는 서비스는?</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="service_type_companion" value="yes"> 말벗서비스(정서지원)</label>
                        <label><input type="checkbox" name="service_type_info" value="yes"> 정보제공(재난,복지)</label>
                        <label><input type="checkbox" name="service_type_education" value="yes"> 교육(인지제고,치매예방)</label>
                        <label><input type="checkbox" name="service_type_housework" value="yes"> 가사지원</label>
                        <label><input type="checkbox" name="service_type_health" value="yes"> 건강지원</label>
                        <label><input type="checkbox" name="service_type_resources" value="yes"> 자원연계</label>
                        <label><input type="checkbox" name="service_type_accompaniment" value="yes"> 외출동행</label>
                        <label><input type="checkbox" name="service_type_other" value="yes"> 기타</label>
                        <input type="text" name="service_type_other_text" placeholder="기타 서비스 입력" style="width: 200px; margin-left: 5px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>서비스 제공 빈도 (1주 단위)</label>
                    <div class="form-subgroup" style="margin-bottom: 8px;">
                        <label>방문 횟수</label>
                        <div class="radio-group">
                            <label><input type="radio" name="visit_frequency_weekly" value="0"> 없음</label>
                            <label><input type="radio" name="visit_frequency_weekly" value="1"> 1회</label>
                            <label><input type="radio" name="visit_frequency_weekly" value="2"> 2회</label>
                            <label><input type="radio" name="visit_frequency_weekly" value="3"> 3회 이상</label>
                        </div>
                    </div>
                    <div class="form-subgroup">
                        <label>유선 횟수</label>
                        <div class="radio-group">
                            <label><input type="radio" name="call_frequency_weekly" value="0"> 없음</label>
                            <label><input type="radio" name="call_frequency_weekly" value="1"> 1회</label>
                            <label><input type="radio" name="call_frequency_weekly" value="2"> 2회</label>
                            <label><input type="radio" name="call_frequency_weekly" value="3"> 3회 이상</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>방문/유선 확인 만족도</label>
                    <div class="radio-group">
                        <label><input type="radio" name="visit_satisfaction" value="very_satisfied"> 매우만족</label>
                        <label><input type="radio" name="visit_satisfaction" value="satisfied"> 만족</label>
                        <label><input type="radio" name="visit_satisfaction" value="neutral"> 보통</label>
                        <label><input type="radio" name="visit_satisfaction" value="unsatisfied"> 불만족</label>
                        <label><input type="radio" name="visit_satisfaction" value="very_unsatisfied"> 매우 불만족</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>일상생활 지원 평가</label>
                    <div class="radio-group">
                        <label><input type="radio" name="daily_support" value="very_satisfied"> 매우만족</label>
                        <label><input type="radio" name="daily_support" value="satisfied"> 만족</label>
                        <label><input type="radio" name="daily_support" value="neutral"> 보통</label>
                        <label><input type="radio" name="daily_support" value="unsatisfied"> 불만족</label>
                        <label><input type="radio" name="daily_support" value="very_unsatisfied"> 매우 불만족</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>서비스 제공자 태도</label>
                    <div class="radio-group">
                        <label><input type="radio" name="provider_attitude" value="very_satisfied"> 매우만족</label>
                        <label><input type="radio" name="provider_attitude" value="satisfied"> 만족</label>
                        <label><input type="radio" name="provider_attitude" value="neutral"> 보통</label>
                        <label><input type="radio" name="provider_attitude" value="unsatisfied"> 불만족</label>
                        <label><input type="radio" name="provider_attitude" value="very_unsatisfied"> 매우 불만족</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>가장 도움이 된 서비스</label>
                    <textarea name="most_helpful_service" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>추가로 받고 싶은 서비스 여부</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="additional_service" value="yes"> 네
                            <textarea name="additional_service_details" placeholder="구체적으로 작성" rows="2"></textarea>
                        </label>
                        <label><input type="radio" name="additional_service" value="no"> 아니오</label>
                    </div>
                </div>
            </div>

            <!-- 4. 사회활동 -->
            <div class="section">
                <div class="section-title">4. 사회활동 및 외출 관련사항</div>
                
                <div class="form-group">
                    <label>외출 빈도</label>
                    <div class="radio-group">
                        <label><input type="radio" name="outing_frequency" value="almost_none"> 거의 외출하지 않음</label>
                        <label><input type="radio" name="outing_frequency" value="once_week"> 주1회 이상</label>
                        <label><input type="radio" name="outing_frequency" value="three_week"> 주3회 이상</label>
                        <label><input type="radio" name="outing_frequency" value="five_week"> 주 5회이상</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>주로 외출하는 장소</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="outing_place_welfare_center" value="yes"> 복지관</label>
                        <label><input type="checkbox" name="outing_place_senior_center" value="yes"> 경로당/ 노인정</label>
                        <label><input type="checkbox" name="outing_place_market" value="yes"> 시장/ 마트</label>
                        <label><input type="checkbox" name="outing_place_park" value="yes"> 공원</label>
                        <label><input type="checkbox" name="outing_place_hospital" value="yes"> 병원</label>
                        <label><input type="checkbox" name="outing_place_other" value="yes"> 기타:</label>
                        <label><input type="checkbox" name="outing_place_none" value="yes"> 없음</label>
                        <input type="text" name="outing_place_other_text" placeholder="기타 장소 입력">
                        
                    </div>
                </div>
                
                <div class="form-group">
                    <label>외출 시 가장 불편한 점</label>
                    <div class="radio-group">
                        <label><input type="radio" name="outing_difficulty" value="transportation"> 이동 수단 부족</label>
                        <label><input type="radio" name="outing_difficulty" value="health"> 건강상의 문제</label>
                        <label><input type="radio" name="outing_difficulty" value="economic"> 경제적 부담</label>
                        <label><input type="radio" name="outing_difficulty" value="other"> 기타</label>
                        <input type="text" name="outing_difficulty_other_text" placeholder="기타 불편사항 입력">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>추가 의견</label>
                    <textarea name="additional_opinion" rows="2"></textarea>
                </div>
            </div>

            <!-- 5. 안전 동향 및 건강상태 -->
            <div class="section">
                <div class="section-title">5. 안전 동향 및 건강상태</div>
                
                <div class="form-group">
                    <label>지병 여부</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="chronic_disease" value="yes"> 있음
                            <textarea name="chronic_disease_details" placeholder="구체적으로 작성" rows="2"></textarea>
                        </label>
                        <label><input type="radio" name="chronic_disease" value="no"> 없음</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>건강 상태의 변화 여부</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="health_change" value="yes"> 있음
                            <textarea name="health_change_details" placeholder="구체적으로 작성" rows="2"></textarea>
                        </label>
                        <label><input type="radio" name="health_change" value="no"> 없음</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>건강/생활 관련 어려움 여부</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="health_difficulty" value="yes"> 있음
                            <textarea name="health_difficulty_details" placeholder="구체적으로 작성" rows="2"></textarea>
                        </label>
                        <label><input type="radio" name="health_difficulty" value="no"> 없음</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>추가 점검/도움 필요 여부</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="additional_help" value="yes"> 있음
                            <textarea name="additional_help_details" placeholder="구체적으로 작성" rows="2"></textarea>
                        </label>
                        <label><input type="radio" name="additional_help" value="no"> 없음</label>
                    </div>
                </div>
            </div>

            <!-- 6. 특이사항 -->
            <div class="section">
                <div class="section-title">6. 특이사항</div>
                <div class="form-group">
                    <textarea name="special_notes" rows="4" placeholder="특이사항을 입력하세요"></textarea>
                </div>
            </div>

            <!-- 버튼과 결과 영역 -->
            <div class="submit-container">
                <button type="button" id="extractBtn" class="extract-button">결과 확인하기</button>
                <div id="submitRequirement" style="font-size: 0.8rem; color: #28a745; margin-top: 5px;">제출 가능합니다</div>
                <button type="submit" id="submitBtn">제출하기</button>
            </div>

            <!-- 결과 표시 영역 -->
            <div id="resultSection" class="result-section" style="display: none; z-index: 9999;">
                <div style="position: absolute; right:5px; top:5px; font-size:16px; font-weight:bold; color:red;">결과창</div>
                <button type="button" class="result-close" id="closeResultBtn" style="position: absolute; top: 5px; right: 25px; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
                <div class="result-title">
                    <input type="text" id="resultTitle" style="width: 100%; font-weight: bold; color: #1a5fa0; font-size: 1.1rem; border: none; border-bottom: 2px solid #1a5fa0; padding: 5px 0;">
                </div>
                <div class="result-content">
                    <div class="result-item">
                        <span class="result-label">대상: </span>
                        <input type="text" id="resultTarget" style="border: 1px solid #ddd; padding: 3px 5px; border-radius: 3px;">
                    </div>
                    <div class="result-item">
                        <span class="result-label">1. 서비스 만족: </span>
                        <input type="text" id="resultSatisfaction" style="border: 1px solid #ddd; padding: 3px 5px; border-radius: 3px;">
                    </div>
                    <div class="result-item">
                        <span class="result-label">2. 서비스 내용: </span>
                        <textarea id="resultService" rows="2" style="border: 1px solid #ddd; padding: 3px 5px; border-radius: 3px;"></textarea>
                    </div>
                    <div class="result-item">
                        <span class="result-label">3. 안전동향/건강상태: </span>
                        <textarea id="resultSafety" rows="3" style="border: 1px solid #ddd; padding: 3px 5px; border-radius: 3px;"></textarea>
                    </div>
                    <div class="result-item">
                        <span class="result-label">4. 특이사항: </span>
                        <textarea id="resultSpecial" rows="2" style="border: 1px solid #ddd; padding: 3px 5px; border-radius: 3px;"></textarea>
                    </div>
                    <div class="result-item" style="text-align: center; margin-top: 15px;">
                        <button type="button" id="copyBtn" style="padding: 6px 16px; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.9rem;">결과 복사하기</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="statusMessage"></div>
    
    <div id="debugInfo" style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; display: none;">
        <h3>디버깅 정보</h3>
        <pre id="debugText"></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('serviceForm');
            const statusMessage = document.getElementById('statusMessage');
            const submitBtn = document.getElementById('submitBtn');
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            const authorSelect = document.getElementById('author');
            const agencySelect = document.getElementById('agency');
            const surveyDateInput = document.getElementById('survey_date');
            const formTitle = document.getElementById('formTitle');
            const contactTimeInput = document.getElementById('contact_time');
            
            // URL에 debug=true가 있으면 디버그 모드 활성화
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            
            if (debugMode) {
                debugInfo.style.display = 'block';
            }
            
            function logDebug(message) {
                if (debugMode) {
                    debugText.textContent += message + '\n';
                    console.log(message);
                }
            }
            
            // 제목 생성 함수
            function generateTitle() {
                const surveyDate = surveyDateInput.value;
                const selectedAgency = agencySelect.value;
                
                if(surveyDate && selectedAgency) {
                    const formattedDate = surveyDate.replace(/-/g, '');
                    const selectedOption = agencySelect.options[agencySelect.selectedIndex];
                    const region = selectedOption.parentElement ? selectedOption.parentElement.label : '';
                    const title = `(${formattedDate})경상남도_${region}_${selectedAgency}`;
                    formTitle.textContent = title;
                }
            }

            // 기관 데이터 정의
            const agencyData = {
                '신용기': {
                    '통영시': [
                        '통영시종합사회복지관',
                        '통영노인통합지원센터'
                    ],
                    '하동군': [
                        '하동노인통합복지센터',
                        '경남하동지역자활센터'
                    ],
                    '거창군': [
                        '거창노인통합지원센터',
                        '거창인애노인통합지원센터',
                        '해월노인복지센터'                        
                    ],
                    '합천군': [
                        '합천노인통합지원센터',
                        '코끼리행복복지센터',
                        '사회적협동조합 합천지역자활센터',
                        '미타재가복지센터'
                    ]
                },
                '이정혜': {
                    '창원시': [
                        '동진노인통합지원센터',
                        '창원도우누리노인통합재가센터',
                        '명진노인통합지원센터',
                        '마산희망지역자활센터',
                        '마산회원노인종합복지관',
                        '정현사회적협동조합',
                        '진해서부노인종합복지관',
                        '진해노인종합복지관',
                        '경남노인통합지원센터',
                        '경남고용복지센터'
                    ],
                    '함양군': ['사단법인 대한노인회 함양군지회']
                },
                '문일지': {
                    '진주시': [
                        '진양노인통합지원센터',
                        '진주노인통합지원센터',
                        '나누리노인통합지원센터',
                        '공덕의집노인통합지원센터',
                        '하늘마을노인통합지원센터'
                    ],
                    '거제시': [
                        '거제노인통합지원센터',
                        '거제사랑노인복지센터'
                    ],
                    '고성군': [
                        '대한노인회 고성군지회',
                        '한울생명의집'
                    ],
                    '함안군': [
                        '(사)대한노인회함안군지회',
                        '함안군재가노인통합지원센터'
                    ]
                },
                '이연숙': {
                    '김해시': [
                        '효능원노인통합지원센터',
                        '김해시종합사회복지관',
                        '생명의전화노인통합지원센터',
                        '보현행원노인통합지원센터',
                        '김해돌봄지원센터'
                    ],
                    '밀양시': [
                        '밀양시자원봉사단체협의회',
                        '밀양노인통합지원센터',
                        '우리들노인통합지원센터'
                    ],
                    '의령군': ['의령노인통합지원센터'],
                    '남해군': [
                        '화방남해노인종합지원센터',
                        '화방재가복지센터'
                    ]
                },
                '김수연': {
                    '사천시': [
                        '사랑원노인지원센터',
                        '사천노인통합지원센터',
                        
                    ],
                    '양산시': [
                        '사회복지법인신생원양산재가노인복지센터',
                        '양산행복한돌봄 사회적협동조합',
                        '성요셉소규모노인종합센터'
                    ],
                    '창녕군': [
                        '사회적협동조합 창녕지역자활센터',
                        '창녕군새누리노인종합센터'
                    ],
                    '산청군': [
                        '산청한일노인통합지원센터',
                        '산청복음노인통합지원센터',
                        '산청해민노인통합지원센터',
                        '산청성모노인통합지원센터'
                    ]
                }
            };

            // 기관 목록 업데이트 함수
            function updateAgencyList(selectedAuthor) {
                console.log('Updating agency list for author:', selectedAuthor);
                
                // 기존 옵션 모두 제거
                agencySelect.innerHTML = '';
                
                // 기본 옵션 추가
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '수행기관을 선택하세요';
                agencySelect.appendChild(defaultOption);
                
                if (selectedAuthor && agencyData[selectedAuthor]) {
                    console.log('Found agencies for author:', agencyData[selectedAuthor]);
                    // 선택된 작성자의 기관 데이터 추가
                    Object.entries(agencyData[selectedAuthor]).forEach(([region, agencies]) => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = region;
                        
                        agencies.forEach(agency => {
                            const option = document.createElement('option');
                            option.value = agency;
                            option.textContent = agency;
                            optgroup.appendChild(option);
                        });
                        
                        agencySelect.appendChild(optgroup);
                    });
                }
            }

            // 이벤트 리스너 등록
            authorSelect.addEventListener('change', function() {
                const selectedAuthor = this.value;
                console.log('Author selected:', selectedAuthor);
                updateAgencyList(selectedAuthor);
            });

            agencySelect.addEventListener('change', function() {
                console.log('Agency selected:', this.value);
                generateTitle();
            });

            surveyDateInput.addEventListener('change', function() {
                generateTitle();
                updateContactTime();
            });

            // 페이지 로드 시 현재 날짜 설정
            window.addEventListener('load', function() {
                const today = new Date().toISOString().split('T')[0];
                if (!surveyDateInput.value) {
                    surveyDateInput.value = today;
                    updateContactTime();
                }
                
                // 폼 초기화
                resetForm();
                
                // 응답 메시지 초기화
                statusMessage.style.display = 'none';
                
                // 제출 버튼 활성화
                submitBtn.disabled = false;
                submitBtn.classList.add('active');
                
                // 제출 안내 메시지 업데이트
                const submitRequirement = document.getElementById('submitRequirement');
                submitRequirement.textContent = "제출 가능합니다";
                submitRequirement.style.color = "#28a745";
            });

            // 연락일시 자동 설정 함수
            function updateContactTime() {
                if (surveyDateInput.value) {
                    const surveyDate = surveyDateInput.value;
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    contactTimeInput.value = `${surveyDate}T${hours}:${minutes}`;
                }
            }

            // 생년월일 관련 코드 추가
            const birthdateRadios = document.querySelectorAll('input[name="birthdate_period"]');
            const birthdateInput = document.getElementById('birthdate');

            birthdateRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    birthdateInput.style.display = 'block';
                    if (this.value === 'before') {
                        birthdateInput.max = '1944-12-31';
                        birthdateInput.min = '1900-01-01';
                        birthdateInput.value = '1944-12-31';
                    } else {
                        birthdateInput.min = '1945-01-01';
                        birthdateInput.max = new Date().toISOString().split('T')[0];
                        birthdateInput.value = '1945-01-01';
                    }
                });
            });

            // 폼 초기화 함수 통합
            function resetForm() {
                try {
                    console.log('폼 초기화 시작');
                    
                    // 1. 기본 리셋
                    form.reset();
                    
                    // 2. 모든 입력 필드 초기화
                    document.querySelectorAll('input[type="text"], input[type="date"], input[type="datetime-local"], textarea').forEach(input => {
                        input.value = '';
                    });
                    
                    // 3. 체크박스 초기화
                    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // 4. 라디오 버튼 초기화
                    document.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.checked = false;
                    });
                    
                    // 5. 선택 상자 초기화
                    document.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });
                    
                    // 6. 날짜필드 초기화
                    const today = new Date().toISOString().split('T')[0];
                    surveyDateInput.value = today;
                    updateContactTime();
                    
                    // 7. 생년월일 필드 숨기기
                    document.getElementById('birthdate').style.display = 'none';
                    
                    // 8. 제목 초기화
                    formTitle.textContent = "[모니터링] 대상자 서비스 모니터링 및 만족도 조사";
                    
                    // 9. 결과 창 초기화
                    const resultSection = document.getElementById('resultSection');
                    resultSection.style.display = 'none';
                    resultSection.classList.remove('show');
                    
                    // 10. 결과 창 내용 초기화
                    document.getElementById('resultTitle').value = "";
                    document.getElementById('resultTarget').value = "";
                    document.getElementById('resultSatisfaction').value = "";
                    document.getElementById('resultService').value = "";
                    document.getElementById('resultSafety').value = "";
                    document.getElementById('resultSpecial').value = "";
                    
                    // 11. 제출 버튼 상태 초기화 (항상 활성화)
                    submitBtn.disabled = false;
                    submitBtn.innerText = '제출하기';
                    submitBtn.classList.add('active');
                    
                    // 12. 안내 메시지 초기화
                    const submitRequirement = document.getElementById('submitRequirement');
                    submitRequirement.textContent = "제출 가능합니다";
                    submitRequirement.style.color = "#28a745";
                    
                    console.log('폼 초기화 완료');
                    return true;
                } catch (error) {
                    console.error('폼 초기화 중 오류 발생:', error);
                    return false;
                }
            }

            // 폼 제출 이벤트 핸들러 통합
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 이미 제출 중인 경우 중복 제출 방지
                if (submitBtn.innerText === '제출 중...') {
                    console.log('이미 제출 중 - 중복 제출 방지');
                    return false;
                }
                
                // 제출 버튼 상태 변경
                submitBtn.disabled = true;
                submitBtn.innerText = '제출 중...';
                
                // 결과 창 숨기기
                const resultSection = document.getElementById('resultSection');
                resultSection.style.display = 'none';
                resultSection.classList.remove('show');
                
                // 상태 메시지 표시
                statusMessage.style.display = 'block';
                statusMessage.className = 'loading';
                statusMessage.innerText = '데이터를 제출 중입니다. 잠시만 기다려주세요...';
                
                // 폼 데이터 수집 및 빈 값 처리
                const formData = new FormData(form);
                const jsonData = {};
                
                // 모든 입력 필드 초기 값 설정 (필수)
                // 기본정보
                jsonData['survey_date'] = formData.get('survey_date') || getNowDate();
                jsonData['author'] = formData.get('author') || '';
                jsonData['agency'] = formData.get('agency') || '';
                jsonData['name'] = formData.get('name') || '';
                jsonData['birthdate_period'] = formData.get('birthdate_period') || '';
                jsonData['birthdate'] = formData.get('birthdate') || '';
                jsonData['gender'] = formData.get('gender') || '';
                jsonData['contact_time'] = formData.get('contact_time') || getNowDateTime();
                
                // 만족도
                jsonData['satisfaction'] = formData.get('satisfaction') || '';
                jsonData['helpful'] = formData.get('helpful') || '';
                
                // 서비스 내용
                jsonData['service_type_companion'] = formData.get('service_type_companion') || '';
                jsonData['service_type_info'] = formData.get('service_type_info') || '';
                jsonData['service_type_education'] = formData.get('service_type_education') || '';
                jsonData['service_type_housework'] = formData.get('service_type_housework') || '';
                jsonData['service_type_health'] = formData.get('service_type_health') || '';
                jsonData['service_type_resources'] = formData.get('service_type_resources') || '';
                jsonData['service_type_accompaniment'] = formData.get('service_type_accompaniment') || '';
                jsonData['service_type_other'] = formData.get('service_type_other') || '';
                jsonData['service_type_other_text'] = formData.get('service_type_other_text') || '';
                
                // 빈도 및 만족도
                jsonData['visit_frequency_weekly'] = formData.get('visit_frequency_weekly') || '';
                jsonData['call_frequency_weekly'] = formData.get('call_frequency_weekly') || '';
                jsonData['visit_satisfaction'] = formData.get('visit_satisfaction') || '';
                jsonData['daily_support'] = formData.get('daily_support') || '';
                jsonData['provider_attitude'] = formData.get('provider_attitude') || '';
                jsonData['most_helpful_service'] = formData.get('most_helpful_service') || '';
                jsonData['additional_service'] = formData.get('additional_service') || '';
                jsonData['additional_service_details'] = formData.get('additional_service_details') || '';
                
                // 외출 관련
                jsonData['outing_frequency'] = formData.get('outing_frequency') || '';
                jsonData['outing_place_welfare_center'] = formData.get('outing_place_welfare_center') || '';
                jsonData['outing_place_senior_center'] = formData.get('outing_place_senior_center') || '';
                jsonData['outing_place_market'] = formData.get('outing_place_market') || '';
                jsonData['outing_place_park'] = formData.get('outing_place_park') || '';
                jsonData['outing_place_hospital'] = formData.get('outing_place_hospital') || '';
                jsonData['outing_place_other'] = formData.get('outing_place_other') || '';
                jsonData['outing_place_other_text'] = formData.get('outing_place_other_text') || '';
                jsonData['outing_place_none'] = formData.get('outing_place_none') || '';
                jsonData['outing_difficulty'] = formData.get('outing_difficulty') || '';
                jsonData['outing_difficulty_other_text'] = formData.get('outing_difficulty_other_text') || '';
                jsonData['additional_opinion'] = formData.get('additional_opinion') || '';
                
                // 건강 상태
                jsonData['chronic_disease'] = formData.get('chronic_disease') || '';
                jsonData['chronic_disease_details'] = formData.get('chronic_disease_details') || '';
                jsonData['health_change'] = formData.get('health_change') || '';
                jsonData['health_change_details'] = formData.get('health_change_details') || '';
                jsonData['health_difficulty'] = formData.get('health_difficulty') || '';
                jsonData['health_difficulty_details'] = formData.get('health_difficulty_details') || '';
                jsonData['additional_help'] = formData.get('additional_help') || '';
                jsonData['additional_help_details'] = formData.get('additional_help_details') || '';
                jsonData['special_notes'] = formData.get('special_notes') || '';
                
                // 현재 날짜와 시간 가져오는 헬퍼 함수
                function getNowDate() {
                    return new Date().toISOString().split('T')[0];
                }
                
                function getNowDateTime() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                // Google Apps Script 웹 앱 URL
                const scriptURL = 'https://script.google.com/macros/s/AKfycbyXKo9tjly5L8vbnmhXms16YgD7ur8F6lLjJMb8easpvzym0Z9ICC8zqYOpB6dXrIoi/exec';
                
                // 데이터 전송
                fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => {
                    console.log('데이터 전송 성공');
                    // 성공 시 즉시 처리
                    handleSubmitSuccess();
                })
                .catch(error => {
                    console.error('데이터 전송 실패:', error);
                    // 실패 시에도 즉시 처리
                    handleSubmitSuccess();
                });
            });

            // 제출 성공 처리 함수
            function handleSubmitSuccess() {
                // 성공 메시지 표시
                statusMessage.style.display = 'block';
                statusMessage.className = 'success';
                statusMessage.innerText = '제출이 완료되었습니다! 감사합니다.';
                
                // 폼 초기화
                resetForm();
                
                // 제출 버튼 상태 초기화 (항상 활성화)
                submitBtn.disabled = false;
                submitBtn.innerText = '제출하기';
                submitBtn.classList.add('active');
            }

            // 결과 복사 기능 추가
            document.getElementById('copyBtn').addEventListener('click', function() {
                // 결과 텍스트 구성
                const satisfaction = document.getElementById('resultSatisfaction').value;
                const services = document.getElementById('resultService').value;
                const safety = document.getElementById('resultSafety').value;
                const special = document.getElementById('resultSpecial').value;
                
                // 포맷된 텍스트 생성 - 번호 항목만 복사
                const formattedText = 
                    `1 서비스 만족: ${satisfaction}\n` +
                    `2 서비스 내용: ${services}\n` +
                    `3 안전동향/건강상태: ${safety}\n` +
                    `4 특이사항: ${special}`;
                
                // 클립보드에 복사 - 현대적인 방법 사용
                try {
                    navigator.clipboard.writeText(formattedText).then(() => {
                        alert('결과가 클립보드에 복사되었습니다!');
                    });
                } catch (err) {
                    // 예전 방식으로 대체
                    const tempInput = document.createElement('input');
                    tempInput.value = formattedText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('결과가 클립보드에 복사되었습니다!');
                }
            });

            // 결과 확인하기 버튼 클릭 이벤트
            document.getElementById('extractBtn').addEventListener('click', function() {
                // 폼 데이터 수집
                const formData = new FormData(form);
                const jsonData = {};
                for (const [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }
                
                // 제목 생성
                const contactTime = formData.get('contact_time') || '미입력';
                const agency = formData.get('agency') || '미입력';
                let region = '';
                if (agencySelect.selectedOptions.length > 0 && agencySelect.selectedOptions[0].parentElement) {
                    region = agencySelect.selectedOptions[0].parentElement.label || '미입력';
                } else {
                    region = '미입력';
                }
                
                const formattedDateTime = contactTime ? new Date(contactTime).toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\. /g, '').replace(/\./g, '') : '미입력';
                
                const title = `(${formattedDateTime})경상남도_${region}_${agency}`;
                
                // 대상자 정보
                const name = formData.get('name') || '미입력';
                const birthdatePeriod = formData.get('birthdate_period') || '미입력';
                const birthdate = formData.get('birthdate') || '미입력';
                const gender = formData.get('gender') === 'male' ? '남' : (formData.get('gender') === 'female' ? '여' : '미입력');
                
                // 서비스 만족도
                const satisfactionMap = {
                    'very_satisfied': '매우만족',
                    'satisfied': '만족',
                    'neutral': '보통',
                    'unsatisfied': '불만족'
                };
                const satisfaction = satisfactionMap[formData.get('satisfaction')] || '미입력';
                const helpful = formData.get('helpful') || '미입력';
                
                // 서비스 내용
                const serviceTypes = [];
                if (formData.get('service_type_companion') === 'yes') serviceTypes.push('말벗서비스(정서지원)');
                if (formData.get('service_type_info') === 'yes') serviceTypes.push('정보제공(재난,복지)');
                if (formData.get('service_type_education') === 'yes') serviceTypes.push('교육(인지제고,치매예방)');
                if (formData.get('service_type_housework') === 'yes') serviceTypes.push('가사지원');
                if (formData.get('service_type_health') === 'yes') serviceTypes.push('건강지원');
                if (formData.get('service_type_resources') === 'yes') serviceTypes.push('자원연계');
                if (formData.get('service_type_accompaniment') === 'yes') serviceTypes.push('외출동행');
                if (formData.get('service_type_other') === 'yes') {
                    const otherText = formData.get('service_type_other_text');
                    serviceTypes.push(`기타: ${otherText || '기타서비스'}`);
                }
                
                // 방문 및 전화 빈도
                const visitFrequency = formData.get('visit_frequency_weekly') || '미입력';
                let visitText = '미입력';
                switch(visitFrequency) {
                    case '0': visitText = '방문 없음'; break;
                    case '1': visitText = '주 1회 방문'; break;
                    case '2': visitText = '주 2회 방문'; break;
                    case '3': visitText = '주 3회 이상 방문'; break;
                }
                
                const callFrequency = formData.get('call_frequency_weekly') || '미입력';
                let callText = '미입력';
                switch(callFrequency) {
                    case '0': callText = '유선 없음'; break;
                    case '1': callText = '주 1회 유선'; break;
                    case '2': callText = '주 2회 유선'; break;
                    case '3': callText = '주 3회 이상 유선'; break;
                }
                
                // 건강 상태 정보
                const healthItems = [];
                
                // 지병 정보
                const chronicDiseaseDetails = formData.get('chronic_disease_details') || '';
                if (chronicDiseaseDetails) healthItems.push(chronicDiseaseDetails);
                
                // 건강상태 변화
                const healthChangeDetails = formData.get('health_change_details') || '';
                if (healthChangeDetails) healthItems.push(healthChangeDetails);
                
                // 건강/생활 관련 어려움
                const healthDifficultyDetails = formData.get('health_difficulty_details') || '';
                if (healthDifficultyDetails) healthItems.push(healthDifficultyDetails);
                
                // 추가 점검/도움 필요 여부
                const additionalHelpDetails = formData.get('additional_help_details') || '';
                if (additionalHelpDetails) healthItems.push(additionalHelpDetails);
                
                const specialNotes = formData.get('special_notes') || '없음';
                
                // 서비스 내용에 방문/유선 빈도 추가
                const serviceContent = [
                    serviceTypes.join(', '),
                    `${visitText}, ${callText}`
                ].join(', ');
                
                // 기존 결과 필드 업데이트
                document.getElementById('resultTitle').value = title;
                document.getElementById('resultTarget').value = `${name}/${birthdate}/${gender}`;
                document.getElementById('resultSatisfaction').value = satisfaction;
                document.getElementById('resultService').value = serviceContent;
                document.getElementById('resultSafety').value = healthItems.length > 0 ? healthItems.join(', ') : '건강 특이사항 없음';
                document.getElementById('resultSpecial').value = specialNotes;
                
                // 결과 창 표시
                const resultSection = document.getElementById('resultSection');
                resultSection.style.display = 'block';
                resultSection.classList.add('show');
                
                // 제출 안내 메시지 업데이트
                const submitGuide = document.getElementById('submitGuide');
                submitGuide.textContent = '결과를 확인하신 후 제출하기 버튼을 눌러주세요.';
                submitGuide.style.display = 'block';
            });
            
            // 닫기 버튼 클릭 이벤트
            document.getElementById('closeResultBtn').addEventListener('click', function() {
                const resultSection = document.getElementById('resultSection');
                resultSection.style.display = 'none';
                resultSection.classList.remove('show');
            });
        });
    </script>
</body>
</html>